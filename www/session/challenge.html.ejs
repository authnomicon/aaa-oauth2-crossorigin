<head>
  <title>Check Origin IFrame</title>
</head>
<body>
  <form method="post" action="/oauth2/co/session">
    <input type="hidden" name="token" value="<%= token %>"/>
    <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
  </form>
  <script type="text/javascript">
    (function(window, document) {
      // TODO: Get origin from param
      var iframe = 'http://localhost:3001/co/verify'
        , origin = 'http://localhost:3001'
        , node;
      
      window.addEventListener('message', function(evt) {
        switch (evt.data.type) {
        case 'ready':
          evt.source.postMessage({ type: 'co_verifier_request' }, origin);
          break;
          
        case 'co_verifier_response':
          if (evt.data.response && evt.data.response.verifier) {
            node = document.createElement('input');
            node.setAttribute('type', 'hidden');
            node.setAttribute('name', 'verifier');
            node.setAttribute('value', evt.data.response.verifier);
            document.forms[0].appendChild(node);
          }
          document.forms[0].submit();
          break;
        }
      });
      
      
      // http://stackoverflow.com/questions/36499719/sending-postmessage-via-iframe-and-open-window-in-safari
      
      node = document.createElement('iframe');
      node.setAttribute('src', iframe);
      document.body.appendChild(node);
    })(this, this.document);
  </script>
</body>
